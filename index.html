<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Delemencia .</title>
<style>
*{font-family:'Segoe UI',Tahoma,sans-serif;margin:0;padding:0;box-sizing:border-box}
body{height:100vh;background:#3a7fb1;display:flex;align-items:center;justify-content:center;overflow:hidden}
.screen{display:none;width:100%;height:100%}
.win-window{width:920px;height:620px;background:#f0f0f0;border:1px solid #004873;box-shadow:0 0 20px rgba(0,0,0,0.6);display:flex;flex-direction:column}
.win-titlebar{background:linear-gradient(to bottom, #74aade 0%, #4f92d1 50%, #2264a2 50%, #1e5a96 100%);height:30px;padding:0 10px;display:flex;align-items:center;justify-content:space-between;color:white;font-size:12px;font-weight:bold;text-shadow:1px 1px 1px #000}
.win-body{flex:1;display:flex;overflow:hidden;position:relative}
#sidebar{width:280px;background:#fff;border-right:1px solid #aaa;display:flex;flex-direction:column}
.user-info{padding:12px;background:#e9f2f9;border-bottom:1px solid #ccc;display:flex;align-items:center;gap:10px}
.pfp-small{width:40px;height:40px;border:1px solid #999;background:#eee;object-fit:cover}
#contacts-area{flex:1;overflow-y:auto}
.section-label{padding:5px 10px;background:#f0f0f0;font-size:11px;font-weight:bold;color:#555;border-bottom:1px solid #ddd}
.contact-item{padding:10px;border-bottom:1px solid #eee;cursor:pointer;display:flex;align-items:center;gap:10px}
.contact-item:hover{background:#e5f3ff}
#chat-pane{flex:1;display:flex;flex-direction:column;background:white}
#chat-head{padding:15px;border-bottom:1px solid #ccc;font-size:16px;color:#004a7c;background:#fafafa;display:flex;align-items:center;gap:10px}
#messages-box{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
.msg-bubble{padding:6px 10px;font-size:13px;border:1px solid #ccc;max-width:75%;word-wrap:break-word}
.me{align-self:flex-end;background:#eff7ff;border-color:#bbd6ec}
.them{align-self:flex-start;background:#f1f1f1}
#input-strip{padding:10px;border-top:1px solid #ccc;display:flex;gap:5px;background:#f0f0f0}
input[type="text"],input[type="password"]{padding:6px;border:1px solid #8e8f8f;outline:none}
input[type="text"]:focus{border-color:#3c7fb1}
button{padding:5px 15px;background:linear-gradient(to bottom, #f2f2f2, #cfcfcf);border:1px solid #707070;cursor:pointer;font-size:12px}
button:hover{background:linear-gradient(to bottom, #eaf6fd, #a7d9f5);border-color:#3c7fb1}
#settings-box{display:none;position:absolute;inset:40px;background:white;border:1px solid #666;box-shadow:0 0 30px rgba(0,0,0,0.5);z-index:100;padding:20px}
.pfp-preview{width:80px;height:80px;border:2px solid #ccc;margin-bottom:10px;object-fit:cover}
</style>
</head>
<body>

<div id="auth-screen" class="screen" style="display:flex;align-items:center;justify-content:center">
    <div class="win-window" style="width:340px;height:auto">
        <div class="win-titlebar"><span>Delemencia .</span></div>
        <div style="padding:25px" id="login-form">
            <h2 style="margin-bottom:15px;font-weight:normal;color:#004a7c">Sign in</h2>
            <input id="lu" placeholder="Username" style="width:100%;margin-bottom:10px">
            <input id="lp" type="password" placeholder="Password" style="width:100%;margin-bottom:15px">
            <button onclick="login()" style="width:100%;padding:8px;font-weight:bold">Sign In</button>
            <div style="margin-top:15px;font-size:11px;text-align:center">
                New to Delemencia? <a href="javascript:void(0)" onclick="toggleAuth(true)">Create account</a>
            </div>
        </div>
        <div style="padding:25px;display:none" id="reg-form">
            <h2 style="margin-bottom:15px;font-weight:normal;color:#004a7c">Create account</h2>
            <input id="ru" placeholder="Pick a username" style="width:100%;margin-bottom:10px">
            <input id="rp" type="password" placeholder="Create password" style="width:100%;margin-bottom:15px">
            <button onclick="register()" style="width:100%;padding:8px;font-weight:bold">Join</button>
            <div style="margin-top:15px;font-size:11px;text-align:center">
                <a href="javascript:void(0)" onclick="toggleAuth(false)">Back to Login</a>
            </div>
        </div>
    </div>
</div>

<div id="app-screen" class="screen">
    <div class="win-window" style="margin:auto;margin-top:20px">
        <div class="win-titlebar">
            <span>Delemencia .</span>
            <div>
                <button onclick="openSet()" style="height:18px;line-height:8px">Settings</button>
            </div>
        </div>
        <div class="win-body">
            <div id="sidebar">
                <div class="user-info">
                    <img id="my-pfp" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="pfp-small">
                    <div>
                        <b id="display-name">User</b><br>
                        <select id="my-status" onchange="upStatus()" style="font-size:10px;border:none;background:transparent;color:#444">
                            <option>Online</option><option>Away</option><option>Busy</option><option>Invisible</option>
                        </select>
                    </div>
                </div>
                <div style="padding:8px;display:flex;gap:3px">
                    <input id="find-user" placeholder="Add someone..." style="flex:1;font-size:12px">
                    <button onclick="reqAdd()">Add</button>
                </div>
                <div id="contacts-area"></div>
            </div>
            <div id="chat-pane">
                <div id="chat-head">Select a conversation</div>
                <div id="messages-box"></div>
                <div id="input-strip">
                    <input id="msg-in" type="text" style="flex:1" placeholder="Type a message...">
                    <button onclick="doSend()">Send</button>
                </div>
            </div>

            <div id="settings-box">
                <h2 style="margin-bottom:20px">Settings</h2>
                <div style="display:flex;gap:30px">
                    <div style="flex:1">
                        <h4>Profile Picture</h4><br>
                        <img id="pfp-pre" class="pfp-preview" src=""><br>
                        <input type="file" id="pfp-file" accept="image/*" onchange="preImg()"><br><br>
                        <button onclick="savePfp()">Update Photo</button>
                    </div>
                    <div style="flex:1">
                        <h4>Appearance</h4><br>
                        <button onclick="theme('#3a7fb1')">Sky Blue</button>
                        <button onclick="theme('#2d5a27')">Forest</button>
                        <button onclick="theme('#111')">Dark</button>
                        <button onclick="theme('#7e22ce')">Nebula</button>
                        <hr style="margin:15px 0">
                        <button onclick="logout()" style="background:#f44336;color:white;border-color:#b71c1c">Logout</button>
                        <button onclick="delAcc()" style="font-size:10px;margin-top:20px;opacity:0.6">Delete Account</button>
                    </div>
                </div>
                <button onclick="closeSet()" style="position:absolute;bottom:20px;right:20px">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let me = null;
let chatWith = null;
const db = () => JSON.parse(localStorage.getItem('del_db') || "{}");
const save = (d) => localStorage.setItem('del_db', JSON.stringify(d));

function toggleAuth(reg){
    document.getElementById('login-form').style.display = reg ? 'none' : 'block';
    document.getElementById('reg-form').style.display = reg ? 'block' : 'none';
}

function register(){
    let u = document.getElementById('ru').value.trim(), p = document.getElementById('rp').value, d = db();
    if(!u || !p || d[u]) return alert("Unavailable");
    d[u] = { pass: p, status: "Online", pfp: "", friends: [], reqs: [], inbox: {} };
    save(d); session(u);
}

function login(){
    let u = document.getElementById('lu').value, p = document.getElementById('lp').value, d = db();
    if(d[u] && d[u].pass === p) session(u);
    else alert("Error");
}

function session(u){
    me = u;
    localStorage.setItem('del_me', u);
    document.getElementById('display-name').textContent = u;
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app-screen').style.display = 'block';
    let d = db();
    if(d[me].pfp) document.getElementById('my-pfp').src = d[me].pfp;
    refresh();
}

function reqAdd(){
    let t = document.getElementById('find-user').value.trim(), d = db();
    if(!t || !d[t] || t === me || d[me].friends.includes(t)) return alert("User not found or added");
    if(!d[t].reqs.includes(me)) d[t].reqs.push(me);
    save(d); alert("Request sent");
    document.getElementById('find-user').value = "";
}

function accept(u){
    let d = db();
    d[me].friends.push(u);
    d[u].friends.push(me);
    d[me].reqs = d[me].reqs.filter(x => x !== u);
    save(d); refresh();
}

function refresh(){
    let d = db(), area = document.getElementById('contacts-area');
    area.innerHTML = "";
    if(d[me].reqs.length > 0){
        area.innerHTML += `<div class="section-label">PENDING</div>`;
        d[me].reqs.forEach(u => {
            area.innerHTML += `<div class="contact-item"><b>${u}</b> <button onclick="accept('${u}')">Add</button></div>`;
        });
    }
    area.innerHTML += `<div class="section-label">CONTACTS</div>`;
    d[me].friends.forEach(u => {
        let pic = d[u].pfp || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
        let div = document.createElement('div');
        div.className = "contact-item";
        div.onclick = () => startChat(u);
        div.innerHTML = `<img src="${pic}" class="pfp-small" style="border-radius:50%"> <div><b>${u}</b><br><span style="font-size:10px;color:green">${d[u].status}</span></div>`;
        area.appendChild(div);
    });
}

function startChat(u){
    chatWith = u;
    document.getElementById('chat-head').textContent = u;
    renderMsgs();
}

function doSend(){
    let txt = document.getElementById('msg-in').value.trim(), d = db();
    if(!chatWith || !txt) return;
    if(!d[me].inbox[chatWith]) d[me].inbox[chatWith] = [];
    if(!d[chatWith].inbox[me]) d[chatWith].inbox[me] = [];
    let m = { s: me, t: txt };
    d[me].inbox[chatWith].push(m);
    d[chatWith].inbox[me].push(m);
    save(d); document.getElementById('msg-in').value = "";
    renderMsgs();
}

function renderMsgs(){
    let d = db(), box = document.getElementById('messages-box');
    box.innerHTML = "";
    if(!chatWith) return;
    (d[me].inbox[chatWith] || []).forEach(m => {
        let div = document.createElement('div');
        div.className = "msg-bubble " + (m.s === me ? "me" : "them");
        div.textContent = m.t;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
}

function preImg(){
    let file = document.getElementById('pfp-file').files[0];
    let reader = new FileReader();
    reader.onload = e => document.getElementById('pfp-pre').src = e.target.result;
    reader.readAsDataURL(file);
}

function savePfp(){
    let d = db();
    d[me].pfp = document.getElementById('pfp-pre').src;
    save(d); document.getElementById('my-pfp').src = d[me].pfp;
    alert("Profile picture updated");
}

function upStatus(){
    let d = db(); d[me].status = document.getElementById('my-status').value;
    save(d); refresh();
}

function theme(c){ document.body.style.background = c; }
function openSet(){ document.getElementById('settings-box').style.display = 'block'; }
function closeSet(){ document.getElementById('settings-box').style.display = 'none'; }
function logout(){ localStorage.removeItem('del_me'); location.reload(); }
function delAcc(){ if(confirm("Delete everything?")){ let d = db(); delete d[me]; save(d); logout(); } }

if(localStorage.getItem('del_me')) session(localStorage.getItem('del_me'));
else document.getElementById('auth-screen').style.display = 'flex';

setInterval(renderMsgs, 2000);
setInterval(refresh, 5000);
</script>
</body>
</html>
