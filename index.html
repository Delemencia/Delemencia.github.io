<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>haha beta .</title>
<style>
*{font-family:'Segoe UI',Tahoma,sans-serif;margin:0;padding:0;box-sizing:border-box}
body{height:100vh;background:#3a7fb1;display:flex;align-items:center;justify-content:center;overflow:hidden;transition:0.5s}
.screen{display:none;width:100%;height:100%}
.win-window{width:960px;height:660px;background:#f0f0f0;border:1px solid #004873;box-shadow:0 0 25px rgba(0,0,0,0.7);display:flex;flex-direction:column;position:relative}
.win-titlebar{background:linear-gradient(to bottom, #74aade 0%, #4f92d1 50%, #2264a2 50%, #1e5a96 100%);height:30px;padding:0 10px;display:flex;align-items:center;justify-content:space-between;color:white;font-size:12px;font-weight:bold;text-shadow:1px 1px 1px #000}
.win-body{flex:1;display:flex;overflow:hidden;position:relative}
#sidebar{width:280px;background:#fff;border-right:1px solid #aaa;display:flex;flex-direction:column}
.user-info{padding:12px;background:#e9f2f9;border-bottom:1px solid #ccc;display:flex;align-items:center;gap:10px}
.pfp-small{width:42px;height:42px;border:1px solid #999;background:#eee;object-fit:cover;border-radius:2px}
#contacts-area{flex:1;overflow-y:auto}
.section-label{padding:5px 10px;background:#f0f0f0;font-size:11px;font-weight:bold;color:#555;border-bottom:1px solid #ddd;border-top:1px solid #ddd}
.contact-item{padding:10px;border-bottom:1px solid #eee;cursor:pointer;display:flex;align-items:center;gap:10px}
.contact-item:hover{background:#e5f3ff}
#chat-pane{flex:1;display:flex;flex-direction:column;background:white}
#chat-head{padding:10px 15px;border-bottom:1px solid #ccc;font-size:16px;color:#004a7c;background:#fafafa;display:flex;align-items:center;justify-content:space-between}
#messages-box{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:5px;background:#fff}
.msg-row{width:100%;display:flex;margin-bottom:2px}
.msg-bubble{padding:4px 10px;font-size:13px;border:1px solid #ccc;max-width:75%;word-wrap:break-word;position:relative}
.me-row{justify-content:flex-end}
.them-row{justify-content:flex-start}
.me{background:#eff7ff;border-color:#bbd6ec}
.them{background:#f1f1f1;border-color:#ddd}
#input-strip{padding:10px;border-top:1px solid #ccc;display:flex;gap:5px;background:#f0f0f0}
input[type="text"],input[type="password"]{padding:6px;border:1px solid #8e8f8f;outline:none}
button{padding:5px 12px;background:linear-gradient(to bottom, #f2f2f2, #cfcfcf);border:1px solid #707070;cursor:pointer;font-size:12px}
button:hover{background:linear-gradient(to bottom, #eaf6fd, #a7d9f5);border-color:#3c7fb1}
.modal{display:none;position:absolute;inset:0;background:rgba(0,0,0,0.4);z-index:200;align-items:center;justify-content:center}
.modal-content{background:white;border:1px solid #666;width:400px;padding:20px;box-shadow:0 0 30px rgba(0,0,0,0.5)}
#settings-box{display:none;position:absolute;inset:40px;background:white;border:1px solid #666;box-shadow:0 0 30px rgba(0,0,0,0.5);z-index:100;padding:20px;overflow-y:auto}
</style>
</head>
<body>

<div id="auth-screen" class="screen" style="display:flex;align-items:center;justify-content:center">
    <div class="win-window" style="width:340px;height:auto">
        <div class="win-titlebar"><span>Delemencia .</span></div>
        <div style="padding:25px" id="login-form">
            <h2 style="margin-bottom:15px;font-weight:normal;color:#004a7c">Sign in</h2>
            <input id="lu" placeholder="Username" style="width:100%;margin-bottom:10px">
            <input id="lp" type="password" placeholder="Password" style="width:100%;margin-bottom:15px">
            <button onclick="login()" style="width:100%;padding:8px;font-weight:bold">Sign In</button>
            <div style="margin-top:15px;font-size:11px;text-align:center">New? <a href="javascript:void(0)" onclick="toggleAuth(true)">Create account</a></div>
        </div>
        <div style="padding:25px;display:none" id="reg-form">
            <h2 style="margin-bottom:15px;font-weight:normal;color:#004a7c">Join</h2>
            <input id="ru" placeholder="Username" style="width:100%;margin-bottom:10px">
            <input id="rp" type="password" placeholder="Password" style="width:100%;margin-bottom:15px">
            <button onclick="register()" style="width:100%;padding:8px;font-weight:bold">Create</button>
            <div style="margin-top:15px;font-size:11px;text-align:center"><a href="javascript:void(0)" onclick="toggleAuth(false)">Back</a></div>
        </div>
    </div>
</div>

<div id="app-screen" class="screen">
    <div class="win-window" style="margin:auto;margin-top:20px">
        <div class="win-titlebar">
            <span>Delemencia .</span>
            <div><button onclick="openSet()" style="height:18px;line-height:8px">Settings</button></div>
        </div>
        <div class="win-body">
            <div id="sidebar">
                <div class="user-info">
                    <img id="my-pfp" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="pfp-small">
                    <div>
                        <b id="display-name">User</b><br>
                        <select id="my-status" onchange="upStatus()" style="font-size:10px;border:none;background:transparent;color:#444">
                            <option>Online</option><option>Away</option><option>Busy</option><option>Invisible</option>
                        </select>
                    </div>
                </div>
                <div style="padding:8px;display:flex;gap:3px">
                    <input id="search-user" placeholder="Search profiles..." style="flex:1;font-size:12px">
                    <button onclick="lookUp()">Search</button>
                </div>
                <div id="contacts-area"></div>
            </div>
            <div id="chat-pane">
                <div id="chat-head">
                    <span id="chat-target-name">Select a conversation</span>
                </div>
                <div id="messages-box"></div>
                <div id="input-strip">
                    <input id="msg-in" type="text" style="flex:1" placeholder="Type a message..." onkeydown="if(event.key==='Enter')doSend()">
                    <button onclick="doSend()">Send</button>
                </div>
            </div>

            <div id="profile-modal" class="modal">
                <div class="modal-content">
                    <h3 style="margin-bottom:15px">User Profile</h3>
                    <div style="display:flex;gap:15px;align-items:center">
                        <img id="view-pfp" src="" class="pfp-small" style="width:80px;height:80px">
                        <div><h2 id="view-name"></h2><p id="view-status" style="font-size:12px"></p></div>
                    </div>
                    <br>
                    <button id="msg-btn" style="width:100%;padding:10px;margin-bottom:5px">Message</button>
                    <button id="block-btn" style="width:100%;padding:10px;margin-bottom:10px;background:#ffcdd2;color:#b71c1c">Block</button>
                    <button onclick="closeModal()" style="width:100%;padding:8px">Close</button>
                </div>
            </div>

            <div id="settings-box">
                <h2 style="margin-bottom:20px">Settings</h2>
                <div style="display:flex;gap:30px">
                    <div style="flex:1">
                        <h4>Profile</h4><br>
                        <img id="pfp-pre" class="pfp-small" style="width:80px;height:80px;display:block;margin-bottom:10px" src=""><br>
                        <input type="file" id="pfp-file" accept="image/*" onchange="preImg()"><br><br>
                        <button onclick="savePfp()">Update Photo</button>
                    </div>
                    <div style="flex:1">
                        <h4>Manage</h4><br>
                        <button onclick="theme('#3a7fb1')">Blue</button><button onclick="theme('#2d5a27')">Forest</button><button onclick="theme('#333')">Dark</button>
                        <hr style="margin:10px 0">
                        <button onclick="logout()" style="background:#f44336;color:white">Logout</button>
                    </div>
                </div>
                <button onclick="closeSet()" style="position:absolute;bottom:20px;right:20px">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let me = null, chatWith = null;
const db = () => JSON.parse(localStorage.getItem('del_db') || "{}");
const save = (d) => localStorage.setItem('del_db', JSON.stringify(d));

function toggleAuth(reg){
    document.getElementById('login-form').style.display = reg ? 'none' : 'block';
    document.getElementById('reg-form').style.display = reg ? 'block' : 'none';
}

function register(){
    let u = document.getElementById('ru').value.trim(), p = document.getElementById('rp').value, d = db();
    if(!u || !p || d[u]) return alert("Username unavailable");
    d[u] = { pass: p, status: "Online", pfp: "", blocked: [], inbox: {} };
    save(d); session(u);
}

function login(){
    let u = document.getElementById('lu').value, p = document.getElementById('lp').value, d = db();
    if(d[u] && d[u].pass === p) session(u);
    else alert("Invalid login");
}

function session(u){
    me = u; localStorage.setItem('del_me', u);
    document.getElementById('display-name').textContent = u;
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app-screen').style.display = 'block';
    let d = db();
    if(d[me].pfp) document.getElementById('my-pfp').src = d[me].pfp;
    refresh();
}

function lookUp(){
    let t = document.getElementById('search-user').value.trim(), d = db();
    let found = Object.keys(d).find(key => key.toLowerCase() === t.toLowerCase());
    if(!found) return alert("User not found");
    document.getElementById('view-name').textContent = found;
    document.getElementById('view-status').textContent = d[found].status;
    document.getElementById('view-pfp').src = d[found].pfp || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
    document.getElementById('msg-btn').onclick = () => { startChat(found); closeModal(); };
    document.getElementById('block-btn').onclick = () => { blockUser(found); closeModal(); };
    document.getElementById('profile-modal').style.display = 'flex';
}

function blockUser(u){
    let d = db(); if(!d[me].blocked.includes(u)) d[me].blocked.push(u);
    save(d); refresh(); alert(u + " blocked.");
}

function startChat(u){
    chatWith = u;
    document.getElementById('chat-target-name').textContent = u;
    renderMsgs();
}

function doSend(){
    let txt = document.getElementById('msg-in').value.trim(), d = db();
    if(!chatWith || !txt) return;
    if(!d[me].inbox[chatWith]) d[me].inbox[chatWith] = [];
    if(!d[chatWith].inbox[me]) d[chatWith].inbox[me] = [];
    let m = { s: me, t: txt, ts: Date.now() };
    d[me].inbox[chatWith].push(m);
    d[chatWith].inbox[me].push(m);
    save(d); document.getElementById('msg-in').value = ""; renderMsgs();
}

function renderMsgs(){
    let d = db(), box = document.getElementById('messages-box');
    box.innerHTML = "";
    if(!chatWith) return;
    let msgs = d[me].inbox[chatWith] || [];
    msgs.forEach(m => {
        let row = document.createElement('div');
        row.className = "msg-row " + (m.s === me ? "me-row" : "them-row");
        let div = document.createElement('div');
        div.className = "msg-bubble " + (m.s === me ? "me" : "them");
        div.textContent = m.t;
        row.appendChild(div);
        box.appendChild(row);
    });
    box.scrollTop = box.scrollHeight;
}

function refresh(){
    let d = db(), area = document.getElementById('contacts-area');
    area.innerHTML = `<div class="section-label">PEOPLE</div>`;
    Object.keys(d).forEach(u => {
        if(u === me || (d[me].blocked && d[me].blocked.includes(u))) return;
        let div = document.createElement('div');
        div.className = "contact-item";
        div.onclick = () => startChat(u);
        div.innerHTML = `<img src="${d[u].pfp || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='}" class="pfp-small"> <div><b>${u}</b><br><span style="font-size:10px;color:green">${d[u].status}</span></div>`;
        area.appendChild(div);
    });
}

function openSet(){ document.getElementById('settings-box').style.display = 'block'; }
function closeSet(){ document.getElementById('settings-box').style.display = 'none'; }
function closeModal(){ document.getElementById('profile-modal').style.display = 'none'; }
function theme(c){ document.body.style.background = c; }
function upStatus(){ let d = db(); d[me].status = document.getElementById('my-status').value; save(d); refresh(); }
function logout(){ localStorage.removeItem('del_me'); location.reload(); }
function preImg(){ let reader = new FileReader(); reader.onload = e => document.getElementById('pfp-pre').src = e.target.result; reader.readAsDataURL(document.getElementById('pfp-file').files[0]); }
function savePfp(){ let d = db(); d[me].pfp = document.getElementById('pfp-pre').src; save(d); document.getElementById('my-pfp').src = d[me].pfp; alert("Saved"); }

if(localStorage.getItem('del_me')) session(localStorage.getItem('del_me'));
else document.getElementById('auth-screen').style.display = 'flex';

setInterval(renderMsgs, 1500);
setInterval(refresh, 5000);
</script>
</body>
</html>
