<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>delemencia!1</title>
<link rel="icon" type="image/png" href="logo.png"> 
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
*{font-family:'Segoe UI', Tahoma, sans-serif;margin:0;padding:0;box-sizing:border-box;border-radius:0 !important}
body{height:100vh;background:#0078d7;display:flex;align-items:center;justify-content:center;overflow:hidden;transition: background 0.3s;background-size: cover;background-position: center;}
#messages-box, #contacts-area, .tab-content {overflow-y: scroll}
::-webkit-scrollbar {width: 17px; background: #f0f0f0; border-left: 1px solid #dcdcdc}
::-webkit-scrollbar-thumb {background: #cdcdcd; border: 1px solid #ababab; box-shadow: inset 1px 1px 0 #eee}
.win-window{width:1050px;height:750px;background:#fff;border:1px solid #555;box-shadow:0 10px 40px rgba(0,0,0,0.5);display:flex;flex-direction:column;position:relative}
.win-titlebar { background: linear-gradient(to bottom, #fff 0%, #ebebeb 100%); height: 32px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: #222; border-bottom: 1px solid #ababab; }
.skype-menu-bar { background: #f0f0f0; border-bottom: 1px solid #ccc; display: flex; padding: 2px 10px; gap: 15px; font-size: 12px; color: #333; }
.menu-item { cursor: pointer; padding: 2px 5px; position: relative; }
.menu-item:hover { background: #0078d7; color: #fff; }
.title-left { display: flex; align-items: center; gap: 8px; }
.skype-logo { width: 18px; height: 18px; background: #00aff0; color: white; border-radius: 50% !important; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; }
.win-body{flex:1;display:flex;overflow:hidden;position:relative}
#sidebar{width:300px;background:#f3f3f3;border-right:1px solid #ccc;display:flex;flex-direction:column}
.user-header{padding:15px;background:#fff;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px}
.section-label{padding:10px 15px;font-size:11px;font-weight:bold;color:#4c76b2;text-transform:uppercase;background:#e9e9e9;border-bottom: 1px solid #ddd;}
.search-container { padding: 10px; background: #fff; border-bottom: 1px solid #ddd; }
.search-input { width: 100%; padding: 6px; border: 1px solid #ccc; font-size: 12px; outline: none; }
.person-item{padding:12px 15px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px;border-bottom:1px solid #eee;background:#fff}
.person-item:hover{background:#e0eef9}
#chat-pane, #home-pane, #help-pane, #call-pane{flex:1;display:none;flex-direction:column;background:#fff}
#chat-pane{display:flex}
#messages-box{flex:1;padding:20px;display:flex;flex-direction:column;gap:8px}
.msg-container { margin-bottom: 5px; }
.msg-sender{font-weight:bold;color:#0078d7;margin-right:8px}
.read-receipt { font-size: 10px; color: #1a7f37; display: block; margin-top: 2px; font-style: italic;}
#input-area{padding:15px;border-top:1px solid #ccc;display:flex;gap:10px}
button{padding:6px 15px;background:#f0f0f0;border:1px solid #999;cursor:pointer;font-size:12px}
.modal{display:none;position:absolute;inset:0;background:rgba(0,0,0,0.3);z-index:999;align-items:center;justify-content:center}
.settings-win{background:#fff;border:1px solid #333;width:700px;height:500px;display:flex;position:relative}
.settings-nav{width:180px;background:#f9f9f9;border-right:1px solid #ccc;display:flex;flex-direction:column}
.nav-item{padding:15px;cursor:pointer;border-bottom:1px solid #eee;font-size:13px}
.nav-item.active{background:#fff;color:#0078d7;font-weight:bold}
.tab-content{flex:1;padding:30px;display:none}
.tab-content.active{display:block}
#incoming-call-overlay { display:none; position:fixed; top:20px; right:20px; width:250px; background:#fff; border:2px solid #0078d7; padding:15px; z-index:9999; box-shadow:0 5px 15px rgba(0,0,0,0.3); text-align:center; }
</style>
</head>
<body>

<div id="incoming-call-overlay">
    <p>Incoming Call from <b id="caller-id">...</b></p><br>
    <button onclick="acceptCall()" style="background:green;color:white;border:none;margin-bottom:5px;width:100%">Accept</button>
    <button onclick="declineCall()" style="background:red;color:white;border:none;width:100%">Decline</button>
</div>

<div id="auth-screen" style="display:flex;width:100%;height:100%;align-items:center;justify-content:center">
    <div class="win-window" style="width:340px;height:auto">
        <div class="win-titlebar"><div class="title-left"><span>Delemencia 1.3</span></div></div>
        <div style="padding:30px">
            <input id="lu" placeholder="Username" style="width:100%;margin-bottom:10px;padding:8px">
            <input id="lp" type="password" placeholder="Password" style="width:100%;margin-bottom:20px;padding:8px">
            <div style="display:flex;gap:10px">
                <button onclick="login()" style="flex:1;background:#0078d7;color:#fff;border:none">Sign In</button>
                <button onclick="register()" style="flex:1">Register</button>
            </div>
        </div>
    </div>
</div>

<div id="app-screen" style="display:none;width:100%;height:100%">
    <div class="win-window" style="margin:auto;margin-top:40px">
        <div class="win-titlebar">
            <div class="title-left"><div class="skype-logo">D</div><span>Delemencia 1.3 :+)</span></div>
            <button onclick="openSet()" style="border:none;background:none;color:#0078d7;cursor:pointer">Settings</button>
        </div>
        <div class="skype-menu-bar">
            <div class="menu-item" onclick="goLastContact()">Contacts</div>
            <div class="menu-item" onclick="showHome()">Conversation</div>
            <div class="menu-item" onclick="openCall()">Call</div>
            <div class="menu-item" onclick="openProfile()">View</div>
            <div class="menu-item" onclick="showHelp()">Help</div>
        </div>
        <div class="win-body">
            <div id="sidebar">
                <div class="user-header">
                    <img id="my-pfp" src="" style="width:48px;height:48px;background:#eee;object-fit:cover">
                    <div><b id="display-name">User</b><br><span id="my-status-text" style="font-size:11px;color:#777">Online</span></div>
                </div>
                <div id="contacts-area">
                    <div class="search-container"><input type="text" class="search-input" id="user-search" placeholder="Search users..." onkeydown="if(event.key==='Enter')findUser()"></div>
                    <div class="section-label" onclick="showHome()" style="cursor:pointer">HOME</div>
                    <div id="people-list"></div>
                </div>
            </div>
            
            <div id="chat-pane">
                <div style="padding:15px;border-bottom:1px solid #eee;background:#fafafa"><b id="chat-target-label">Select a contact</b></div>
                <div id="messages-box"></div>
                <div id="input-area">
                    <input id="msg-in" type="text" style="flex:1;padding:8px" placeholder="Type a message..." onkeydown="if(event.key==='Enter')doSend()">
                    <button onclick="doSend()" style="background:#0078d7;color:#fff;border:none">Send</button>
                </div>
            </div>

            <div id="call-pane" style="align-items:center;justify-content:center;text-align:center">
                <div style="background:#f9f9f9; padding:40px; border:1px solid #ccc; width:400px">
                    <h2>Voice Call</h2><br>
                    <input id="call-target" placeholder="Enter Username" style="width:100%; padding:10px; margin-bottom:10px">
                    <button onclick="initiateCall()" style="background:#2e7d32; color:#fff; width:100%; border:none; padding:10px">Call Now</button>
                    <div id="call-status" style="margin-top:20px; font-weight:bold; color:#0078d7"></div>
                    <button onclick="goBack()" style="margin-top:20px;">Back to Chat</button>
                </div>
            </div>

            <div id="help-pane" style="align-items:center;justify-content:center;text-align:center">
                <h1 style="font-weight:300">Check out the forums!</h1>
                <button onclick="goBack()" style="margin-top:20px;">Back</button>
            </div>

            <div id="home-pane" style="align-items:center;justify-content:center;flex:1">
                <h1 style="font-weight:300;">Welcome home, <span id="home-user"></span></h1>
                <p style="color:#777; margin-top:10px;">Select a contact to start chatting.</p>
            </div>
        </div>

        <div id="settings-box" class="modal">
            <div class="settings-win">
                <div class="settings-nav">
                    <div class="nav-item active" onclick="setTab('prof', this)">Profile</div>
                    <div class="nav-item" onclick="setTab('priv', this)">Privacy</div>
                    <button onclick="closeModal()" style="margin-top:auto;margin-bottom:10px">Close</button>
                    <button onclick="logout()" style="color:red;margin-bottom:10px">Logout</button>
                </div>
                <div class="tab-content active" id="tab-prof">
                    <h2>Profile</h2><br>
                    <input id="status-in" style="width:100%;padding:8px" placeholder="Update Status"><br><br>
                    <button onclick="saveStat()" style="background:#0078d7;color:#fff;border:none">Update</button>
                    <hr style="margin:20px 0">
                    <div id="owner-tools" style="display:none">
                        <h3>Admin Tools</h3>
                        <p style="font-size:11px; color:#666">Muted users list:</p>
                        <div id="muted-list" style="font-size:12px; margin-top:10px"></div>
                    </div>
                </div>
                <div class="tab-content" id="tab-priv">
                    <h2>Privacy</h2><br>
                    <input id="new-pass" type="password" style="width:100%;padding:8px" placeholder="New Password"><br><br>
                    <button onclick="changePass()" style="background:#0078d7;color:#fff;border:none">Change Password</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {apiKey: "AIzaSyCjxTPqRH00ND04p0wDa9tI50Q6LSZEnJ8", authDomain: "delemencia.firebaseapp.com", databaseURL: "https://delemencia-default-rtdb.firebaseio.com", projectId: "delemencia", storageBucket: "delemencia.firebasestorage.app", messagingSenderId: "192535641895", appId: "1:192535641895:web:6a3d97d488ef6481d9f382"};
firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();
let me = localStorage.getItem('del_me'), chatWith = null, recent = [];
const notify = new Audio('https://waitingforatrain.neocities.org/notif.mp3');

function login(){
    let u=document.getElementById('lu').value, p=document.getElementById('lp').value;
    rdb.ref('users/'+u).once('value', s=>{
        if(s.val() && s.val().pass===p) session(u);
        else alert("Invalid credentials.");
    });
}

function register(){
    let u=document.getElementById('lu').value, p=document.getElementById('lp').value;
    if(!u || !p) return;
    if(u.toLowerCase().includes("owner")) { alert("Username restricted."); return; }
    rdb.ref('users/'+u).set({pass:p, status:"New user!", muted:false}).then(()=>session(u));
}

function session(u){
    me=u; localStorage.setItem('del_me', u);
    document.getElementById('display-name').textContent=u; 
    document.getElementById('home-user').textContent=u;
    document.getElementById('auth-screen').style.display='none'; 
    document.getElementById('app-screen').style.display='flex';
    
    if(me.toLowerCase() === 'owner') document.getElementById('owner-tools').style.display = 'block';

    rdb.ref('calls/'+me).on('value', s=>{
        if(s.exists() && s.val().status === 'ringing'){
            document.getElementById('caller-id').textContent = s.val().from;
            document.getElementById('incoming-call-overlay').style.display = 'block';
            notify.play();
        }
    });

    rdb.ref('users/'+me).on('value', s=>{
        let isMuted = s.val() && s.val().muted;
        document.getElementById('msg-in').disabled = isMuted;
        document.getElementById('msg-in').placeholder = isMuted ? "You are currently muted." : "Type a message...";
    });

    loadPeople();
    if(me.toLowerCase() === 'owner') listenMuted();
}

function initiateCall(){
    let t = document.getElementById('call-target').value;
    if(!t || t === me) return;
    rdb.ref('calls/'+t).set({ from: me, status: 'ringing' });
    document.getElementById('call-status').textContent = "Ringing " + t + "...";
}

function acceptCall(){
    let caller = document.getElementById('caller-id').textContent;
    rdb.ref('calls/'+me).update({status: 'connected'});
    document.getElementById('incoming-call-overlay').style.display = 'none';
    alert("Call Connected. You are now talking with " + caller);
}

function declineCall(){
    rdb.ref('calls/'+me).remove();
    document.getElementById('incoming-call-overlay').style.display = 'none';
}

function doSend(){
    let t=document.getElementById('msg-in').value.trim(); if(!chatWith||!t) return;
    
    if(me.toLowerCase() === "owner"){
        if(t.startsWith("!mute ")){
            let target = t.split(" ")[1];
            rdb.ref('users/'+target+'/muted').set(true);
            document.getElementById('msg-in').value=""; return;
        }
        if(t.startsWith("!unmute ")){
            let target = t.split(" ")[1];
            rdb.ref('users/'+target+'/muted').set(false);
            document.getElementById('msg-in').value=""; return;
        }
    }

    let path = [me,chatWith].sort().join("_");
    rdb.ref('chats/'+path).push({s:me, t:t, read:false});
    document.getElementById('msg-in').value="";
}

function listenMsgs(){
    let path = [me,chatWith].sort().join("_");
    rdb.ref('chats/'+path).on('value', s=>{
        let b=document.getElementById('messages-box'); b.innerHTML="";
        s.forEach(c=>{ 
            let m=c.val(); 
            if(m.s !== me && !m.read) {
                rdb.ref('chats/'+path+'/'+c.key).update({read:true, readAt: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})});
            }
            let div = document.createElement('div');
            div.className = "msg-container";
            let receipt = (m.s === me && m.read) ? `<span class="read-receipt">Read at ${m.readAt}</span>` : "";
            div.innerHTML = `<span class="msg-sender">${m.s}:</span> ${m.t} ${receipt}`;
            b.appendChild(div);
        });
        b.scrollTop=b.scrollHeight;
    });
}

function listenMuted(){
    rdb.ref('users').on('value', s=>{
        let list = document.getElementById('muted-list'); list.innerHTML = "";
        s.forEach(u=>{
            if(u.val().muted) list.innerHTML += `â€¢ ${u.key} (Muted)<br>`;
        });
    });
}

function startChat(user){
    chatWith=user; document.getElementById('chat-target-label').textContent=user; 
    if(!recent.includes(user)) recent.unshift(user);
    goBack(); listenMsgs();
}

function loadPeople(){
    rdb.ref('users').on('value', s=>{
        let pList=document.getElementById('people-list'); pList.innerHTML="";
        s.forEach(c=>{
            if(c.key===me) return;
            let div=document.createElement('div'); div.className="person-item";
            div.innerHTML=`<b>${c.key}</b>`;
            div.onclick=()=> startChat(c.key);
            pList.appendChild(div);
        });
    });
}

function goLastContact() { if(recent.length > 0) startChat(recent[0]); else showHome(); }
function hidePanes() { ['chat-pane', 'home-pane', 'help-pane', 'call-pane'].forEach(p => document.getElementById(p).style.display = 'none'); }
function showHome(){ hidePanes(); document.getElementById('home-pane').style.display='flex'; }
function goBack(){ hidePanes(); document.getElementById('chat-pane').style.display='flex'; }
function showHelp() { hidePanes(); document.getElementById('help-pane').style.display = 'flex'; }
function openCall() { hidePanes(); document.getElementById('call-pane').style.display = 'flex'; }
function openProfile() { openSet(); }
function openSet(){ document.getElementById('settings-box').style.display='flex'; }
function closeModal(){ document.getElementById('settings-box').style.display='none'; }
function setTab(t, el){ document.querySelectorAll('.nav-item, .tab-content').forEach(x=>x.classList.remove('active')); el.classList.add('active'); document.getElementById('tab-'+t).classList.add('active'); }
function saveStat(){ rdb.ref('users/'+me+'/status').set(document.getElementById('status-in').value); alert("Status updated!"); }
function changePass(){ rdb.ref('users/'+me+'/pass').set(document.getElementById('new-pass').value); alert("Password changed!"); }
function logout(){ localStorage.clear(); location.reload(); }
if(me) session(me);
</script>
</body>
</html>
